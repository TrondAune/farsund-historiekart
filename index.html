<!DOCTYPE html>
<html lang="no">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Farsund historiekart</title>
    <!-- MapLibre GL & noUiSlider -->
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>
    <style>
      :root { --sidebar-width: 300px; }
      body {
        margin: 0;
        font-family: system-ui, sans-serif;
        display: grid;
        grid-template-columns: 1fr var(--sidebar-width);
        grid-template-rows: 1fr auto;
        height: 100vh;
      }
      #map { grid-column: 1 / 2; grid-row: 1 / 2; }
      #info {
        grid-column: 2 / 3;
        grid-row: 1 / 2;
        overflow-y: auto;
        padding: 1rem;
        border-left: 1px solid #ddd;
        background: #fdfdfd;
      }
      #info.hidden { display: none; }
      #slider-wrapper {
        grid-column: 1 / 3;
        grid-row: 2 / 3;
        padding: 0.75rem 1rem;
        background: rgba(255,255,255,0.9);
        backdrop-filter: blur(4px);
      }
      h2 { margin-top: 0; }
      img { max-width:100%; height:auto; border-radius:4px; }
      .noUi-connect { background:#1e40af; }
    </style>
  </head>
  <body>
    <div id="map"></div>
    <aside id="info" class="hidden"><p>Klikk et objekt på kartet for detaljer.</p></aside>
    <div id="slider-wrapper">
      <div id="year-slider"></div>
      <span id="year-label" style="display:block;margin-top:0.5rem;font-weight:bold;text-align:center"></span>
    </div>

    <script>
      const map = new maplibregl.Map({
        container: 'map',
        style: 'style/terrain-natural-no-modern.json',
        center: [6.8, 58.1],
        zoom: 11
      });

      const info = document.getElementById('info');
      function showInfo(p){
        info.innerHTML=`<h2>${p.name||'Ukjent objekt'}</h2><p><strong>Periode:</strong> ${fmtPeriod(p.start_year,p.end_year)}</p>`+
          (p.description?`<p>${p.description}</p>`:'')+
          (p.img?`<img src="${p.img}" alt="${p.name}">`:'');
        info.classList.remove('hidden');
      }
      function fmtPeriod(s,e){const f=y=>y<0?`${Math.abs(y)} f.Kr.`:y;return `${f(s)} – ${f(e===9999?new Date().getFullYear():e)}`}

      map.on('load',()=>{
        map.addSource('historic',{type:'geojson',data:'data/mock-features.geojson'});
        map.addLayer({id:'historic-layer',type:'circle',source:'historic',paint:{'circle-radius':6,'circle-color':'#d97706'},filter:['all']});
        map.addSource('waterline',{type:'geojson',data:'data/mock-waterlines-topo.geojson'});
        map.addLayer({id:'waterline-fill',type:'fill',source:'waterline',paint:{'fill-color':'#60a5fa','fill-opacity':0.45},filter:['all']});
        map.on('click','historic-layer',e=>{if(!e.features.length)return;showInfo(e.features[0].properties);});
      });

      const slider=document.getElementById('year-slider');
      noUiSlider.create(slider,{start:[-1700],connect:[true,false],range:{min:-8000,max:1900},step:50});
      const yearLabel=document.getElementById('year-label');
      yearLabel.textContent='År: 1700 f.Kr.';
      slider.noUiSlider.on('update',v=>{const y=Math.round(v[0]);yearLabel.textContent=`År: ${y<0?Math.abs(y)+' f.Kr.':y}`;updateFilters(y);});
      function updateFilters(y){
        const f=['all',['<=',['get','start_year'],y],['>=',['get','end_year'],y]];
        if(map.getLayer('historic-layer')) map.setFilter('historic-layer',f);
        if(map.getLayer('waterline-fill')) map.setFilter('waterline-fill',f);
      }
    </script>
  </body>
</html>